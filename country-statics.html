<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å›½åˆ¥æ¥å ´è€…çµ±è¨ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Noto Sans JP', sans-serif; background: #f4f8fb; margin: 0; }
    header { background: #3b82f6; color: #fff; padding: 24px 0; font-size: 26px; font-weight: bold; text-align: center; }
    main { max-width: 800px; margin: 30px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(59,130,246,0.08); padding: 30px 20px; }
    h2 { color: #2563eb; margin-top: 30px; }
    .stat-table { width: 100%; border-collapse: collapse; margin: 18px 0 30px 0; }
    .stat-table th, .stat-table td { border: 1px solid #ccc; padding: 8px 10px; text-align: center; }
    .stat-table th { background: #e0e7ff; }
    .highlight { background: #fef9c3; }
    .desc { color: #64748b; font-size: 15px; margin-bottom: 18px; }
    #reload-btn { margin-bottom: 18px; }
    .chart-area { display: flex; gap: 40px; flex-wrap: wrap; justify-content: center; margin: 30px 0; }
    .chart-area > div { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); padding: 16px; }
    .chart-area h3 { text-align: center; margin: 0 0 10px 0; font-size: 16px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="apple-touch-icon" href="country-statics-thumb.png">
  <link rel="icon" type="image/png" sizes="192x192" href="country-statics-thumb.png">
  <link rel="manifest" href="manifest-country-statics.json">
</head>
<body>
  <header>å›½åˆ¥æ¥å ´è€…çµ±è¨ˆ</header>
  <main>
    <div class="desc">
      <button id="reload-btn" onclick="loadStatics()">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§å†é›†è¨ˆ</button>
      <br>
      <span>country.htmlã§è¨˜éŒ²ã—ãŸå…¨ãƒ‡ãƒ¼ã‚¿ã®ç´¯è¨ˆãƒ»æ—¥åˆ¥ãƒ»å›½åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãªã©ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</span>
    </div>

    <!-- å††ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢è¿½åŠ  -->
    <div class="chart-area">
      <div>
        <h3>åœ°åŸŸåˆ¥ å††ã‚°ãƒ©ãƒ•</h3>
        <canvas id="regionPieChart" width="300" height="300"></canvas>
      </div>
      <div>
        <h3>å›½åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚° å††ã‚°ãƒ©ãƒ•</h3>
        <canvas id="countryPieChart" width="300" height="300"></canvas>
      </div>
    </div>

    <h2>ç´¯è¨ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
    <table class="stat-table" id="total-table">
      <thead>
        <tr>
          <th>é †ä½</th>
          <th>å›½</th>
          <th>äººæ•°åˆè¨ˆ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <h2>æ—¥åˆ¥é›†è¨ˆ</h2>
    <table class="stat-table" id="date-table">
      <thead>
        <tr>
          <th>æ—¥ä»˜</th>
          <th>åˆè¨ˆäººæ•°</th>
          <th>æœ€å¤šå›½</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <h2>æœ€è¿‘ã®è¨˜éŒ²ï¼ˆæœ€æ–°20ä»¶ï¼‰</h2>
    <table class="stat-table" id="recent-table">
      <thead>
        <tr>
          <th>æ—¥ä»˜</th>
          <th>æ™‚é–“</th>
          <th>å›½</th>
          <th>äººæ•°</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>
  <script>
const firebaseConfig = {
  apiKey: "AIzaSyDSZohtnPXem6m7f6A63KjXTQMUUFNk0Cg",
  authDomain: "ghost-entrance.firebaseapp.com",
  databaseURL: "https://ghost-entrance-default-rtdb.firebaseio.com",
  projectId: "ghost-entrance",
  storageBucket: "ghost-entrance.firebasestorage.app",
  messagingSenderId: "977704976997",
  appId: "1:977704976997:web:e61ef8bdc61babc2757c8c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// countryListã¯country.htmlã¨åŒã˜å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„
const countryList = [
  // ã‚¢ã‚¸ã‚¢
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡°ğŸ‡·", jp:"éŸ“å›½", en:"South Korea"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¨ğŸ‡³", jp:"ä¸­å›½", en:"China"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¹ğŸ‡¼", jp:"å°æ¹¾", en:"Taiwan"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡­ğŸ‡°", jp:"é¦™æ¸¯", en:"Hong Kong"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¹ğŸ‡­", jp:"ã‚¿ã‚¤", en:"Thailand"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡»ğŸ‡³", jp:"ãƒ™ãƒˆãƒŠãƒ ", en:"Vietnam"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡µğŸ‡­", jp:"ãƒ•ã‚£ãƒªãƒ”ãƒ³", en:"Philippines"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡®ğŸ‡©", jp:"ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢", en:"Indonesia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡²ğŸ‡¾", jp:"ãƒãƒ¬ãƒ¼ã‚·ã‚¢", en:"Malaysia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¸ğŸ‡¬", jp:"ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«", en:"Singapore"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡®ğŸ‡³", jp:"ã‚¤ãƒ³ãƒ‰", en:"India"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡µğŸ‡°", jp:"ãƒ‘ã‚­ã‚¹ã‚¿ãƒ³", en:"Pakistan"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡³ğŸ‡µ", jp:"ãƒãƒ‘ãƒ¼ãƒ«", en:"Nepal"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡±ğŸ‡°", jp:"ã‚¹ãƒªãƒ©ãƒ³ã‚«", en:"Sri Lanka"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡²ğŸ‡³", jp:"ãƒ¢ãƒ³ã‚´ãƒ«", en:"Mongolia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡§ğŸ‡©", jp:"ãƒãƒ³ã‚°ãƒ©ãƒ‡ã‚·ãƒ¥", en:"Bangladesh"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡°ğŸ‡­", jp:"ã‚«ãƒ³ãƒœã‚¸ã‚¢", en:"Cambodia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡±ğŸ‡¦", jp:"ãƒ©ã‚ªã‚¹", en:"Laos"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡§ğŸ‡³", jp:"ãƒ–ãƒ«ãƒã‚¤", en:"Brunei"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¹ğŸ‡±", jp:"æ±ãƒ†ã‚£ãƒ¢ãƒ¼ãƒ«", en:"Timor-Leste"},
  // æ¬§å·
  {region:"æ¬§å·", flag:"ğŸ‡¬ğŸ‡§", jp:"ã‚¤ã‚®ãƒªã‚¹", en:"United Kingdom"},
  {region:"æ¬§å·", flag:"ğŸ‡«ğŸ‡·", jp:"ãƒ•ãƒ©ãƒ³ã‚¹", en:"France"},
  {region:"æ¬§å·", flag:"ğŸ‡©ğŸ‡ª", jp:"ãƒ‰ã‚¤ãƒ„", en:"Germany"},
  {region:"æ¬§å·", flag:"ğŸ‡®ğŸ‡¹", jp:"ã‚¤ã‚¿ãƒªã‚¢", en:"Italy"},
  {region:"æ¬§å·", flag:"ğŸ‡ªğŸ‡¸", jp:"ã‚¹ãƒšã‚¤ãƒ³", en:"Spain"},
  {region:"æ¬§å·", flag:"ğŸ‡³ğŸ‡±", jp:"ã‚ªãƒ©ãƒ³ãƒ€", en:"Netherlands"},
  {region:"æ¬§å·", flag:"ğŸ‡¨ğŸ‡­", jp:"ã‚¹ã‚¤ã‚¹", en:"Switzerland"},
  {region:"æ¬§å·", flag:"ğŸ‡¸ğŸ‡ª", jp:"ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³", en:"Sweden"},
  {region:"æ¬§å·", flag:"ğŸ‡³ğŸ‡´", jp:"ãƒãƒ«ã‚¦ã‚§ãƒ¼", en:"Norway"},
  {region:"æ¬§å·", flag:"ğŸ‡«ğŸ‡®", jp:"ãƒ•ã‚£ãƒ³ãƒ©ãƒ³ãƒ‰", en:"Finland"},
  {region:"æ¬§å·", flag:"ğŸ‡©ğŸ‡°", jp:"ãƒ‡ãƒ³ãƒãƒ¼ã‚¯", en:"Denmark"},
  {region:"æ¬§å·", flag:"ğŸ‡¦ğŸ‡¹", jp:"ã‚ªãƒ¼ã‚¹ãƒˆãƒªã‚¢", en:"Austria"},
  {region:"æ¬§å·", flag:"ğŸ‡µğŸ‡±", jp:"ãƒãƒ¼ãƒ©ãƒ³ãƒ‰", en:"Poland"},
  {region:"æ¬§å·", flag:"ğŸ‡¨ğŸ‡¿", jp:"ãƒã‚§ã‚³", en:"Czech Republic"},
  {region:"æ¬§å·", flag:"ğŸ‡§ğŸ‡ª", jp:"ãƒ™ãƒ«ã‚®ãƒ¼", en:"Belgium"},
  // åŒ—ç±³
  {region:"åŒ—ç±³", flag:"ğŸ‡ºğŸ‡¸", jp:"ã‚¢ãƒ¡ãƒªã‚«", en:"United States"},
  {region:"åŒ—ç±³", flag:"ğŸ‡¨ğŸ‡¦", jp:"ã‚«ãƒŠãƒ€", en:"Canada"},
  // ä¸­å—ç±³
  {region:"ä¸­å—ç±³", flag:"ğŸ‡²ğŸ‡½", jp:"ãƒ¡ã‚­ã‚·ã‚³", en:"Mexico"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡§ğŸ‡·", jp:"ãƒ–ãƒ©ã‚¸ãƒ«", en:"Brazil"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡¦ğŸ‡·", jp:"ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³", en:"Argentina"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡¨ğŸ‡±", jp:"ãƒãƒª", en:"Chile"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡µğŸ‡ª", jp:"ãƒšãƒ«ãƒ¼", en:"Peru"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡¨ğŸ‡´", jp:"ã‚³ãƒ­ãƒ³ãƒ“ã‚¢", en:"Colombia"},
  // ã‚ªã‚»ã‚¢ãƒ‹ã‚¢
  {region:"ã‚ªã‚»ã‚¢ãƒ‹ã‚¢", flag:"ğŸ‡¦ğŸ‡º", jp:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢", en:"Australia"},
  {region:"ã‚ªã‚»ã‚¢ãƒ‹ã‚¢", flag:"ğŸ‡³ğŸ‡¿", jp:"ãƒ‹ãƒ¥ãƒ¼ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰", en:"New Zealand"},
  // ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¹ğŸ‡·", jp:"ãƒˆãƒ«ã‚³", en:"Turkey"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¸ğŸ‡¦", jp:"ã‚µã‚¦ã‚¸ã‚¢ãƒ©ãƒ“ã‚¢", en:"Saudi Arabia"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¦ğŸ‡ª", jp:"ã‚¢ãƒ©ãƒ–é¦–é•·å›½é€£é‚¦", en:"United Arab Emirates"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¿ğŸ‡¦", jp:"å—ã‚¢ãƒ•ãƒªã‚«", en:"South Africa"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡ªğŸ‡¬", jp:"ã‚¨ã‚¸ãƒ—ãƒˆ", en:"Egypt"}
];

let regionPieChart, countryPieChart;

function loadStatics() {
  db.ref('country').get().then(snapshot => {
    if (!snapshot.exists()) return;
    const allData = [];
    const obj = snapshot.val();
    Object.keys(obj).forEach(key => {
      allData.push({ ...obj[key], key });
    });

    // å††ã‚°ãƒ©ãƒ•ç”¨ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
    // åœ°åŸŸåˆ¥
    const regionMap = {};
    allData.forEach(row => {
      const c = countryList[row.countryIdx];
      const region = c && c.region ? c.region : 'ãã®ä»–';
      if (!regionMap[region]) regionMap[region] = 0;
      regionMap[region] += Number(row.count);
    });
    const regionLabels = Object.keys(regionMap);
    const regionData = Object.values(regionMap);

    // å›½åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    const countryMap = {};
    allData.forEach(row => {
      const c = countryList[row.countryIdx];
      const key = c ? `${c.flag} ${c.jp}` : 'ä¸æ˜';
      if (!countryMap[key]) countryMap[key] = 0;
      countryMap[key] += Number(row.count);
    });
    const sortedCountries = Object.entries(countryMap).sort((a, b) => b[1] - a[1]);
    const countryLabels = sortedCountries.map(([name]) => name);
    const countryDataArr = sortedCountries.map(([, count]) => count);

    // åœ°åŸŸåˆ¥å††ã‚°ãƒ©ãƒ•
    if (regionPieChart) regionPieChart.destroy();
    regionPieChart = new Chart(document.getElementById('regionPieChart'), {
      type: 'pie',
      data: {
        labels: regionLabels,
        datasets: [{
          data: regionData,
          backgroundColor: [
            '#60a5fa', '#fbbf24', '#34d399', '#f87171', '#a78bfa', '#f472b6', '#facc15', '#38bdf8'
          ],
        }]
      },
      options: {
        plugins: {
          legend: { display: false }
        }
      }
    });

    // å›½åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å††ã‚°ãƒ©ãƒ•
    if (countryPieChart) countryPieChart.destroy();
    countryPieChart = new Chart(document.getElementById('countryPieChart'), {
      type: 'pie',
      data: {
        labels: countryLabels,
        datasets: [{
          data: countryDataArr,
          backgroundColor: [
            '#60a5fa', '#fbbf24', '#34d399', '#f87171', '#a78bfa', '#f472b6', '#facc15', '#38bdf8',
            '#818cf8', '#fb7185', '#bef264', '#fdba74', '#fcd34d', '#a3e635', '#fca5a5', '#c4b5fd'
          ],
        }]
      },
      options: {
        plugins: {
          legend: { display: false }
        }
      }
    });

    // ç´¯è¨ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°
    const countryMap2 = {};
    allData.forEach(row => {
      const c = countryList[row.countryIdx];
      const key = `${c.flag} ${c.jp} (${c.en})`;
      if (!countryMap2[key]) countryMap2[key] = 0;
      countryMap2[key] += Number(row.count);
    });
    const sorted = Object.entries(countryMap2).sort((a, b) => b[1] - a[1]);
    const totalTbody = document.querySelector('#total-table tbody');
    totalTbody.innerHTML = '';
    sorted.forEach(([name, count], i) => {
      totalTbody.innerHTML += `<tr${i === 0 ? ' class="highlight"' : ''}><td>${i+1}</td><td>${name}</td><td>${count}</td></tr>`;
    });

    // æ—¥åˆ¥é›†è¨ˆ
    const dateMap = {};
    allData.forEach(row => {
      if (!dateMap[row.date]) dateMap[row.date] = [];
      dateMap[row.date].push(row);
    });
    const dateTbody = document.querySelector('#date-table tbody');
    dateTbody.innerHTML = '';
    Object.keys(dateMap).sort().reverse().forEach(date => {
      const rows = dateMap[date];
      const total = rows.reduce((a, b) => a + Number(b.count), 0);
      // æœ€å¤šå›½
      const tmpMap = {};
      rows.forEach(r => {
        const c = countryList[r.countryIdx];
        const key = `${c.flag} ${c.jp} (${c.en})`;
        if (!tmpMap[key]) tmpMap[key] = 0;
        tmpMap[key] += Number(r.count);
      });
      const maxCountry = Object.entries(tmpMap).sort((a, b) => b[1] - a[1])[0];
      dateTbody.innerHTML += `<tr><td>${date}</td><td>${total}</td><td>${maxCountry ? `${maxCountry[0]}ï¼ˆ${maxCountry[1]}äººï¼‰` : '-'}</td></tr>`;
    });

    // æœ€æ–°20ä»¶
    const recentTbody = document.querySelector('#recent-table tbody');
    recentTbody.innerHTML = '';
    allData.slice(-20).reverse().forEach(row => {
      const c = countryList[row.countryIdx];
      recentTbody.innerHTML += `<tr>
        <td>${row.date}</td>
        <td>${row.time || ''}</td>
        <td>${c.flag} ${c.jp} (${c.en})</td>
        <td>${row.count}</td>
      </tr>`;
    });
  });
}

// åˆæœŸè¡¨ç¤º
loadStatics();
  </script>