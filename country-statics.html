<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å›½åˆ¥æ¥å ´è€…å…¥åŠ›</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <style>
    body { font-family: 'Noto Sans JP', sans-serif; background: #f4f8fb; margin: 0; }
    header { background: #3b82f6; color: #fff; padding: 24px 0; font-size: 26px; font-weight: bold; text-align: center; }
    .container { display: flex; max-width: 1100px; margin: 30px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(59,130,246,0.08); min-height: 700px; }
    .left-list {
      width: 320px;
      border-right: 1px solid #e5e7eb;
      padding: 32px 18px;
      display: flex;
      flex-direction: column;
      background: #f8fafc;
    }
    .left-list-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 18px;
      color: #2563eb;
    }
    .input-items {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 18px;
    }
    .input-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .input-item:last-child { border-bottom: none; }
    .input-item-country {
      font-size: 16px;
      font-weight: bold;
      color: #1e293b;
    }
    .input-item-qty {
      font-size: 15px;
      color: #64748b;
      margin-left: 8px;
    }
    .input-total {
      font-size: 18px;
      font-weight: bold;
      color: #1e293b;
      text-align: right;
      margin-top: 18px;
    }
    .main-area {
      flex: 1;
      padding: 32px;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .country-header {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 18px;
      color: #2563eb;
    }
    .input-row { margin: 0 0 18px 0; }
    .input-row label { font-size: 16px; }
    .country-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 14px;
      margin-bottom: 40px;
    }
    .country-btn {
      background: #e0e7ff;
      border: none;
      border-radius: 0;
      font-size: 18px;
      font-weight: 600;
      color: #2563eb;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      box-shadow: 0 2px 8px rgba(59,130,246,0.07);
      width: 100%;
      height: 70px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      outline: none;
    }
    .country-btn.selected {
      background: #3b82f6;
      color: #fff;
      border: 2.5px solid #2563eb;
    }
    .country-flag-bg {
      font-size: 28px;
      margin-bottom: 2px;
    }
    .country-btn .count {
      position: absolute;
      top: 8px;
      right: 14px;
      background: #2563eb;
      color: #fff;
      font-size: 15px;
      border-radius: 10px;
      padding: 2px 10px;
      font-weight: bold;
    }
    .action-area {
      display: flex;
      justify-content: flex-end;
      gap: 18px;
      margin-top: auto;
    }
    .square-btn {
      width: 180px;
      padding: 18px 0;
      border-radius: 0;
      border: none;
      background: #e0e7ff;
      color: #2563eb;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(59,130,246,0.07);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      text-align: center;
    }
    .square-btn.main {
      background: #3b82f6;
      color: #fff;
      border: 2px solid #2563eb;
    }
    .square-btn:hover {
      background: #bae6fd;
    }
    .msg { color: #2563eb; margin-left: 10px; align-self: center; }
    .history-area {
      margin-top: 40px;
    }
    .history-area h2 {
      font-size: 18px;
      color: #2563eb;
      margin-bottom: 12px;
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }
    .history-table th,
    .history-table td {
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      text-align: center;
      font-size: 14px;
    }
    .history-table th {
      background: #e0e7ff;
      color: #1e293b;
      font-weight: 600;
    }
    .history-table td button {
      background: #f87171;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
    }
    .ranking-section {
      max-width: 1100px;
      margin: 0 auto 40px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(59,130,246,0.08);
      padding: 30px;
    }
    .ranking-section h2 {
      font-size: 20px;
      color: #2563eb;
      margin-bottom: 18px;
    }
    .filter-area {
      margin-bottom: 18px;
      text-align: center;
    }
    .filter-area label {
      margin: 0 8px;
    }
    .filter-area button {
      margin-left: 8px;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 18px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
    }
    .filter-area button:hover {
      background: #2563eb;
    }
    .stat-table {
      width: 100%;
      border-collapse: collapse;
      margin: 18px 0 30px 0;
    }
    .stat-table th,
    .stat-table td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: center;
    }
    .stat-table th {
      background: #e0e7ff;
    }
    .highlight {
      background: #fef9c3;
    }
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .left-list { width: 100%; border-right: none; border-bottom: 1px solid #e5e7eb; }
      .main-area { padding: 18px; }
      .action-area { flex-direction: column; align-items: stretch; }
      .country-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <header>å›½åˆ¥æ¥å ´è€…å…¥åŠ›</header>
  <div class="container">
    <div class="left-list">
      <div class="left-list-header">å…¥åŠ›ãƒªã‚¹ãƒˆ</div>
      <div class="input-items" id="inputItems"></div>
      <div class="input-total" id="inputTotal">åˆè¨ˆ 0ä»¶</div>
    </div>
    <div class="main-area">
      <div class="country-header">å›½åˆ¥æ¥å ´è€…å…¥åŠ›</div>
      <div class="input-row">
        <label>æ—¥ä»˜: <input type="date" id="date-input"></label>
      </div>
      <div class="country-grid" id="countryGrid"></div>
      <div class="action-area">
        <button class="square-btn" onclick="clearPanel()">ã‚¯ãƒªã‚¢</button>
        <button class="square-btn main" onclick="submitData()">é€ä¿¡</button>
        <span id="msg" class="msg"></span>
      </div>
      <div class="history-area">
        <h2>æœ¬æ—¥ã®å±¥æ­´</h2>
        <table class="history-table">
          <thead>
            <tr>
              <th>æ—¥ä»˜</th>
              <th>æ™‚é–“</th>
              <th>å›½</th>
              <th>äººæ•°</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="ranking-section">
    <h2>æŒ‡å®šæ—¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
    <div class="filter-area">
      <label>æ—¥ä»˜: <input type="date" id="ranking-date"></label>
      <button onclick="loadDailyRanking()">è¡¨ç¤º</button>
      <button onclick="copyDailyRanking()">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
    <table class="stat-table" id="daily-ranking-table">
      <thead>
        <tr>
          <th>é †ä½</th>
          <th>å›½</th>
          <th>äººæ•°</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
const firebaseConfig = {
  apiKey: "AIzaSyDSZohtnPXem6m7f6A63KjXTQMUUFNk0Cg",
  authDomain: "ghost-entrance.firebaseapp.com",
  databaseURL: "https://ghost-entrance-default-rtdb.firebaseio.com",
  projectId: "ghost-entrance",
  storageBucket: "ghost-entrance.firebasestorage.app",
  messagingSenderId: "977704976997",
  appId: "1:977704976997:web:e61ef8bdc61babc2757c8c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const countryList = [
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡°ğŸ‡·", jp:"éŸ“å›½", en:"South Korea"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¨ğŸ‡³", jp:"ä¸­å›½", en:"China"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¹ğŸ‡¼", jp:"å°æ¹¾", en:"Taiwan"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡­ğŸ‡°", jp:"é¦™æ¸¯", en:"Hong Kong"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¹ğŸ‡­", jp:"ã‚¿ã‚¤", en:"Thailand"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡»ğŸ‡³", jp:"ãƒ™ãƒˆãƒŠãƒ ", en:"Vietnam"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡µğŸ‡­", jp:"ãƒ•ã‚£ãƒªãƒ”ãƒ³", en:"Philippines"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡®ğŸ‡©", jp:"ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢", en:"Indonesia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡²ğŸ‡¾", jp:"ãƒãƒ¬ãƒ¼ã‚·ã‚¢", en:"Malaysia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¸ğŸ‡¬", jp:"ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«", en:"Singapore"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡®ğŸ‡³", jp:"ã‚¤ãƒ³ãƒ‰", en:"India"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡µğŸ‡°", jp:"ãƒ‘ã‚­ã‚¹ã‚¿ãƒ³", en:"Pakistan"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡³ğŸ‡µ", jp:"ãƒãƒ‘ãƒ¼ãƒ«", en:"Nepal"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡±ğŸ‡°", jp:"ã‚¹ãƒªãƒ©ãƒ³ã‚«", en:"Sri Lanka"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡²ğŸ‡³", jp:"ãƒ¢ãƒ³ã‚´ãƒ«", en:"Mongolia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡§ğŸ‡©", jp:"ãƒãƒ³ã‚°ãƒ©ãƒ‡ã‚·ãƒ¥", en:"Bangladesh"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡°ğŸ‡­", jp:"ã‚«ãƒ³ãƒœã‚¸ã‚¢", en:"Cambodia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡±ğŸ‡¦", jp:"ãƒ©ã‚ªã‚¹", en:"Laos"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡§ğŸ‡³", jp:"ãƒ–ãƒ«ãƒã‚¤", en:"Brunei"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¹ğŸ‡±", jp:"æ±ãƒ†ã‚£ãƒ¢ãƒ¼ãƒ«", en:"Timor-Leste"},
  {region:"æ¬§å·", flag:"ğŸ‡¬ğŸ‡§", jp:"ã‚¤ã‚®ãƒªã‚¹", en:"United Kingdom"},
  {region:"æ¬§å·", flag:"ğŸ‡«ğŸ‡·", jp:"ãƒ•ãƒ©ãƒ³ã‚¹", en:"France"},
  {region:"æ¬§å·", flag:"ğŸ‡©ğŸ‡ª", jp:"ãƒ‰ã‚¤ãƒ„", en:"Germany"},
  {region:"æ¬§å·", flag:"ğŸ‡®ğŸ‡¹", jp:"ã‚¤ã‚¿ãƒªã‚¢", en:"Italy"},
  {region:"æ¬§å·", flag:"ğŸ‡ªğŸ‡¸", jp:"ã‚¹ãƒšã‚¤ãƒ³", en:"Spain"},
  {region:"æ¬§å·", flag:"ğŸ‡³ğŸ‡±", jp:"ã‚ªãƒ©ãƒ³ãƒ€", en:"Netherlands"},
  {region:"æ¬§å·", flag:"ğŸ‡¨ğŸ‡­", jp:"ã‚¹ã‚¤ã‚¹", en:"Switzerland"},
  {region:"æ¬§å·", flag:"ğŸ‡¸ğŸ‡ª", jp:"ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³", en:"Sweden"},
  {region:"æ¬§å·", flag:"ğŸ‡³ğŸ‡´", jp:"ãƒãƒ«ã‚¦ã‚§ãƒ¼", en:"Norway"},
  {region:"æ¬§å·", flag:"ğŸ‡«ğŸ‡®", jp:"ãƒ•ã‚£ãƒ³ãƒ©ãƒ³ãƒ‰", en:"Finland"},
  {region:"æ¬§å·", flag:"ğŸ‡©ğŸ‡°", jp:"ãƒ‡ãƒ³ãƒãƒ¼ã‚¯", en:"Denmark"},
  {region:"æ¬§å·", flag:"ğŸ‡¦ğŸ‡¹", jp:"ã‚ªãƒ¼ã‚¹ãƒˆãƒªã‚¢", en:"Austria"},
  {region:"æ¬§å·", flag:"ğŸ‡µğŸ‡±", jp:"ãƒãƒ¼ãƒ©ãƒ³ãƒ‰", en:"Poland"},
  {region:"æ¬§å·", flag:"ğŸ‡¨ğŸ‡¿", jp:"ãƒã‚§ã‚³", en:"Czech Republic"},
  {region:"æ¬§å·", flag:"ğŸ‡§ğŸ‡ª", jp:"ãƒ™ãƒ«ã‚®ãƒ¼", en:"Belgium"},
  {region:"åŒ—ç±³", flag:"ğŸ‡ºğŸ‡¸", jp:"ã‚¢ãƒ¡ãƒªã‚«", en:"United States"},
  {region:"åŒ—ç±³", flag:"ğŸ‡¨ğŸ‡¦", jp:"ã‚«ãƒŠãƒ€", en:"Canada"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡²ğŸ‡½", jp:"ãƒ¡ã‚­ã‚·ã‚³", en:"Mexico"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡§ğŸ‡·", jp:"ãƒ–ãƒ©ã‚¸ãƒ«", en:"Brazil"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡¦ğŸ‡·", jp:"ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³", en:"Argentina"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡¨ğŸ‡±", jp:"ãƒãƒª", en:"Chile"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡µğŸ‡ª", jp:"ãƒšãƒ«ãƒ¼", en:"Peru"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡¨ğŸ‡´", jp:"ã‚³ãƒ­ãƒ³ãƒ“ã‚¢", en:"Colombia"},
  {region:"ã‚ªã‚»ã‚¢ãƒ‹ã‚¢", flag:"ğŸ‡¦ğŸ‡º", jp:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢", en:"Australia"},
  {region:"ã‚ªã‚»ã‚¢ãƒ‹ã‚¢", flag:"ğŸ‡³ğŸ‡¿", jp:"ãƒ‹ãƒ¥ãƒ¼ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰", en:"New Zealand"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¹ğŸ‡·", jp:"ãƒˆãƒ«ã‚³", en:"Turkey"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¸ğŸ‡¦", jp:"ã‚µã‚¦ã‚¸ã‚¢ãƒ©ãƒ“ã‚¢", en:"Saudi Arabia"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¦ğŸ‡ª", jp:"ã‚¢ãƒ©ãƒ–é¦–é•·å›½é€£é‚¦", en:"United Arab Emirates"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¿ğŸ‡¦", jp:"å—ã‚¢ãƒ•ãƒªã‚«", en:"South Africa"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡ªğŸ‡¬", jp:"ã‚¨ã‚¸ãƒ—ãƒˆ", en:"Egypt"}
];

const panelCountryIndexes = [
  35,1,0,21,20,43,36,4,25,23,22,10,27,45,6,8,44,37,46,47,26,28,9,3,2
];

const topCountryList = panelCountryIndexes.map(idx => countryList[idx]);
let panelCounts = Array(topCountryList.length).fill(0);
let inputList = [];
let historyList = [];
let historyKeys = [];

// æ—¥ä»˜ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‡ªå‹•å…¥åŠ›ï¼ˆ7æ™‚ã¾ã§ã¯å‰æ—¥ã€ãã‚Œä»¥é™ã¯å½“æ—¥ï¼‰
function setDefaultDate() {
  const now = new Date();
  const dateObj = new Date(now);
  if (now.getHours() < 7) {
    dateObj.setDate(now.getDate() - 1);
  }
  const yyyy = dateObj.getFullYear();
  const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
  const dd = String(dateObj.getDate()).padStart(2, '0');
  document.getElementById('date-input').value = `${yyyy}-${mm}-${dd}`;
}

// å›½ãƒ‘ãƒãƒ«ç”Ÿæˆ
function renderCountryPanel() {
  const panel = document.getElementById('countryGrid');
  panel.innerHTML = '';
  topCountryList.forEach((c, idx) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'country-btn' + (panelCounts[idx] ? ' selected' : '');
    btn.innerHTML = `
      <span class="country-flag-bg">${c.flag}</span>
      <span>${c.jp}</span>
      ${panelCounts[idx] ? `<span class="count">Ã—${panelCounts[idx]}</span>` : ''}
    `;
    btn.onclick = () => {
      panelCounts[idx]++;
      const existIdx = inputList.findIndex(item => item.idx === idx);
      if (existIdx >= 0) {
        inputList[existIdx].qty++;
      } else {
        inputList.push({ idx, qty: 1 });
      }
      renderCountryPanel();
      renderInputList();
    };
    panel.appendChild(btn);
  });
}

// å·¦å´ãƒªã‚¹ãƒˆæç”»
function renderInputList() {
  const area = document.getElementById('inputItems');
  area.innerHTML = '';
  inputList.forEach((item, i) => {
    const c = topCountryList[item.idx];
    area.innerHTML += `
      <div class="input-item">
        <span>
          <span class="input-item-country">${c.flag} ${c.jp}</span>
          <span class="input-item-qty">Ã—${item.qty}</span>
        </span>
        <button onclick="removeInput(${i})">å‰Šé™¤</button>
      </div>
    `;
  });
  const total = inputList.reduce((sum, item) => sum + item.qty, 0);
  document.getElementById('inputTotal').textContent = `åˆè¨ˆ ${total}ä»¶`;
}

// å…¥åŠ›å‰Šé™¤
function removeInput(i) {
  const entry = inputList[i];
  if (!entry) return;
  panelCounts[entry.idx] = Math.max(0, panelCounts[entry.idx] - entry.qty);
  inputList.splice(i, 1);
  renderCountryPanel();
  renderInputList();
}

// ã‚¯ãƒªã‚¢
function clearPanel() {
  panelCounts = Array(topCountryList.length).fill(0);
  inputList = [];
  renderCountryPanel();
  renderInputList();
  document.getElementById('msg').textContent = '';
}

// é€ä¿¡
function submitData() {
  const date = document.getElementById('date-input').value;
  if (!date) {
    document.getElementById('msg').textContent = 'æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    return;
  }
  if (inputList.length === 0) {
    document.getElementById('msg').textContent = 'å›½ã‚’é¸æŠã—ã¦ãã ã•ã„';
    return;
  }
  inputList.forEach(item => {
    const time = getNowTimeStr();
    db.ref('country').push({
      date,
      countryIdx: panelCountryIndexes[item.idx],
      count: item.qty,
      time
    });
  });
  clearPanel();
  document.getElementById('msg').textContent = 'é€ä¿¡ã—ã¾ã—ãŸ';
  setTimeout(() => { document.getElementById('msg').textContent = ''; }, 2000);
  loadHistory();
  loadDailyRanking();
}

// ç¾åœ¨æ™‚åˆ»ï¼ˆhh:mmï¼‰
function getNowTimeStr() {
  const d = new Date();
  return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
}

// å±¥æ­´å–å¾—
function loadHistory() {
  const date = document.getElementById('date-input').value;
  if (!date) return;
  db.ref('country').orderByChild('date').equalTo(date).once('value').then(snapshot => {
    historyList = [];
    historyKeys = [];
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        historyList.push(child.val());
        historyKeys.push(child.key);
      });
    }
    renderHistory();
  });
}

// å±¥æ­´æç”»
function renderHistory() {
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = '';
  const rows = historyList.map((row, i) => ({ row, key: historyKeys[i] })).reverse();
  rows.forEach(item => {
    const c = countryList[item.row.countryIdx];
    const flagName = c ? `${c.flag} ${c.jp}` : 'ä¸æ˜';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.row.date}</td>
      <td>${item.row.time || '--:--'}</td>
      <td>${flagName}</td>
      <td>${item.row.count}</td>
      <td><button onclick="deleteHistory('${item.key}')">å‰Šé™¤</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// å±¥æ­´å‰Šé™¤
function deleteHistory(key) {
  if (!key) return;
  if (!confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;
  db.ref('country/' + key).remove().then(() => {
    loadHistory();
    loadDailyRanking();
  });
}

// æŒ‡å®šæ—¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
function loadDailyRanking() {
  const date = document.getElementById('ranking-date').value;
  const tbody = document.querySelector('#daily-ranking-table tbody');
  tbody.innerHTML = '';
  if (!date) {
    tbody.innerHTML = '<tr><td colspan="3">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>';
    return;
  }
  db.ref('country').orderByChild('date').equalTo(date).once('value').then(snapshot => {
    if (!snapshot.exists()) {
      tbody.innerHTML = '<tr><td colspan="3">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    const agg = {};
    snapshot.forEach(s => {
      const v = s.val();
      const idx = Number(v.countryIdx);
      const cnt = Number(v.count || 0);
      if (!Number.isFinite(idx)) return;
      agg[idx] = (agg[idx] || 0) + cnt;
    });
    const ranking = Object.entries(agg)
      .map(([idx, count]) => {
        const c = countryList[Number(idx)];
        const name = c ? `${c.flag} ${c.jp}` : 'ä¸æ˜';
        return { name, count: Number(count) };
      })
      .sort((a, b) => b.count - a.count);

    let total = 0;
    ranking.forEach((r, i) => {
      total += r.count;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i + 1}</td><td>${r.name}</td><td>${r.count}</td>`;
      tbody.appendChild(tr);
    });
    const trTotal = document.createElement('tr');
    trTotal.className = 'highlight';
    trTotal.innerHTML = `<td colspan="2">åˆè¨ˆï¼ˆ${ranking.length}ã‚«å›½ï¼‰</td><td>${total}</td>`;
    tbody.appendChild(trTotal);
  }).catch(err => {
    console.error(err);
    tbody.innerHTML = '<tr><td colspan="3">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
  });
}

// æŒ‡å®šæ—¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§ã‚³ãƒ”ãƒ¼
function copyDailyRanking() {
  const date = document.getElementById('ranking-date').value;
  if (!date) {
    alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  db.ref('country').orderByChild('date').equalTo(date).once('value').then(snapshot => {
    if (!snapshot.exists()) {
      alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    const agg = {};
    snapshot.forEach(s => {
      const v = s.val();
      const idx = Number(v.countryIdx);
      const cnt = Number(v.count || 0);
      if (!Number.isFinite(idx)) return;
      agg[idx] = (agg[idx] || 0) + cnt;
    });
    const ranking = Object.entries(agg)
      .map(([idx, count]) => {
        const c = countryList[Number(idx)];
        const name = c ? `${c.flag} ${c.jp}` : 'ä¸æ˜';
        return { name, count: Number(count) };
      })
      .sort((a, b) => b.count - a.count);

    let total = 0;
    let text = `ã€æŒ‡å®šæ—¥ã®å›½åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€‘${date}\n\n`;
    ranking.forEach((r, i) => {
      total += r.count;
      const percent = ((r.count / total) * 100).toFixed(0);
      text += `${i + 1}ä½\t${r.name}\t${r.count}äºº(${percent}%)\n`;
    });
    text += `\nåˆè¨ˆ: ${total}äººï¼ˆ${ranking.length}ã‚«å›½ï¼‰\n`;

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      }).catch(err => {
        console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  }).catch(err => {
    console.error(err);
    alert('å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  });
}

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚³ãƒ”ãƒ¼
function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand('copy');
    alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  } catch {
    alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
  document.body.removeChild(ta);
}

// åˆæœŸåŒ–
function initRankingDate() {
  const pad = n => String(n).padStart(2, '0');
  const d = new Date();
  const today = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
  const el = document.getElementById('ranking-date');
  if (el) {
    el.value = today;
    loadDailyRanking();
    el.addEventListener('change', loadDailyRanking);
  }
}

// åˆæœŸè¡¨ç¤º
window.addEventListener('DOMContentLoaded', () => {
  setDefaultDate();
  renderCountryPanel();
  renderInputList();
  loadHistory();
  initRankingDate();
});
document.getElementById('date-input').addEventListener('change', () => {
  loadHistory();
});
  </script>
</body>
</html>