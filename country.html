<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å›½åˆ¥æ¥å ´è€…è¨˜éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Noto Sans JP', sans-serif; margin: 0; background: #fafafa; }
    header { background: #eee; padding: 10px 20px; font-size: 20px; font-weight: bold; text-align: center; }
    main { max-width: 700px; margin: 30px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 20px; }
    .input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    select, input[type="number"], input[type="date"] { font-size: 16px; padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #007bff; color: #fff; border: none; border-radius: 6px; padding: 6px 16px; font-size: 15px; cursor: pointer; }
    button:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f2f2f2; }
    .flag { font-size: 20px; }
    .edit-row select, .edit-row input[type="number"] { width: 110px; }
    .edit-btn, .save-btn { margin: 0 2px; }
    #export-result { margin-top: 20px; }
    #export-text { width: 100%; font-size: 16px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <link rel="apple-touch-icon" href="country-thumb.png">
  <link rel="icon" type="image/png" sizes="192x192" href="country-thumb.png">
  <link rel="manifest" href="manifest-country.json">
</head>
<body>
  <header>å›½åˆ¥æ¥å ´è€…è¨˜éŒ²</header>
  <main>
    <div class="input-row">
      <label>æ—¥ä»˜: <input type="date" id="date-input" ></label>
      <label>åœ°åŸŸ: 
        <select id="region-select"></select>
      </label>
      <label>å›½: 
        <select id="country-select"></select>
      </label>
      <label>äººæ•°: <input type="number" id="count-input" min="1" style="width:70px;"></label>
      <button onclick="addCountryRow()">è¿½åŠ </button>
      <button onclick="resetCountryData()" style="background:#dc3545;">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>æ—¥ä»˜</th>
          <th>æ™‚é–“</th>
          <th>åœ°åŸŸ</th>
          <th>å›½</th>
          <th>äººæ•°</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="country-table-body"></tbody>
    </table>
    <div style="margin-top:20px;">
      <button onclick="exportSummary()">å‡ºåŠ›</button>
    </div>
    <div id="export-result" style="margin-top:10px;">
      <textarea id="export-text" rows="8" readonly></textarea>
      <button onclick="copyExportText()" style="margin-top:5px;">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </main>
  <script>
const firebaseConfig = {
  apiKey: "AIzaSyDSZohtnPXem6m7f6A63KjXTQMUUFNk0Cg",
  authDomain: "ghost-entrance.firebaseapp.com",
  databaseURL: "https://ghost-entrance-default-rtdb.firebaseio.com",
  projectId: "ghost-entrance",
  storageBucket: "ghost-entrance.firebasestorage.app",
  messagingSenderId: "977704976997",
  appId: "1:977704976997:web:e61ef8bdc61babc2757c8c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const countryList = [
  // ã‚¢ã‚¸ã‚¢
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡°ğŸ‡·", jp:"éŸ“å›½", en:"South Korea"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¨ğŸ‡³", jp:"ä¸­å›½", en:"China"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¹ğŸ‡¼", jp:"å°æ¹¾", en:"Taiwan"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡­ğŸ‡°", jp:"é¦™æ¸¯", en:"Hong Kong"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¹ğŸ‡­", jp:"ã‚¿ã‚¤", en:"Thailand"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡»ğŸ‡³", jp:"ãƒ™ãƒˆãƒŠãƒ ", en:"Vietnam"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡µğŸ‡­", jp:"ãƒ•ã‚£ãƒªãƒ”ãƒ³", en:"Philippines"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡®ğŸ‡©", jp:"ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢", en:"Indonesia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡²ğŸ‡¾", jp:"ãƒãƒ¬ãƒ¼ã‚·ã‚¢", en:"Malaysia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¸ğŸ‡¬", jp:"ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«", en:"Singapore"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡®ğŸ‡³", jp:"ã‚¤ãƒ³ãƒ‰", en:"India"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡µğŸ‡°", jp:"ãƒ‘ã‚­ã‚¹ã‚¿ãƒ³", en:"Pakistan"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡³ğŸ‡µ", jp:"ãƒãƒ‘ãƒ¼ãƒ«", en:"Nepal"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡±ğŸ‡°", jp:"ã‚¹ãƒªãƒ©ãƒ³ã‚«", en:"Sri Lanka"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡²ğŸ‡³", jp:"ãƒ¢ãƒ³ã‚´ãƒ«", en:"Mongolia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡§ğŸ‡©", jp:"ãƒãƒ³ã‚°ãƒ©ãƒ‡ã‚·ãƒ¥", en:"Bangladesh"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡°ğŸ‡­", jp:"ã‚«ãƒ³ãƒœã‚¸ã‚¢", en:"Cambodia"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡±ğŸ‡¦", jp:"ãƒ©ã‚ªã‚¹", en:"Laos"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡§ğŸ‡³", jp:"ãƒ–ãƒ«ãƒã‚¤", en:"Brunei"},
  {region:"ã‚¢ã‚¸ã‚¢", flag:"ğŸ‡¹ğŸ‡±", jp:"æ±ãƒ†ã‚£ãƒ¢ãƒ¼ãƒ«", en:"Timor-Leste"},
  // æ¬§å·
  {region:"æ¬§å·", flag:"ğŸ‡¬ğŸ‡§", jp:"ã‚¤ã‚®ãƒªã‚¹", en:"United Kingdom"},
  {region:"æ¬§å·", flag:"ğŸ‡«ğŸ‡·", jp:"ãƒ•ãƒ©ãƒ³ã‚¹", en:"France"},
  {region:"æ¬§å·", flag:"ğŸ‡©ğŸ‡ª", jp:"ãƒ‰ã‚¤ãƒ„", en:"Germany"},
  {region:"æ¬§å·", flag:"ğŸ‡®ğŸ‡¹", jp:"ã‚¤ã‚¿ãƒªã‚¢", en:"Italy"},
  {region:"æ¬§å·", flag:"ğŸ‡ªğŸ‡¸", jp:"ã‚¹ãƒšã‚¤ãƒ³", en:"Spain"},
  {region:"æ¬§å·", flag:"ğŸ‡³ğŸ‡±", jp:"ã‚ªãƒ©ãƒ³ãƒ€", en:"Netherlands"},
  {region:"æ¬§å·", flag:"ğŸ‡¨ğŸ‡­", jp:"ã‚¹ã‚¤ã‚¹", en:"Switzerland"},
  {region:"æ¬§å·", flag:"ğŸ‡¸ğŸ‡ª", jp:"ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³", en:"Sweden"},
  {region:"æ¬§å·", flag:"ğŸ‡³ğŸ‡´", jp:"ãƒãƒ«ã‚¦ã‚§ãƒ¼", en:"Norway"},
  {region:"æ¬§å·", flag:"ğŸ‡«ğŸ‡®", jp:"ãƒ•ã‚£ãƒ³ãƒ©ãƒ³ãƒ‰", en:"Finland"},
  {region:"æ¬§å·", flag:"ğŸ‡©ğŸ‡°", jp:"ãƒ‡ãƒ³ãƒãƒ¼ã‚¯", en:"Denmark"},
  {region:"æ¬§å·", flag:"ğŸ‡¦ğŸ‡¹", jp:"ã‚ªãƒ¼ã‚¹ãƒˆãƒªã‚¢", en:"Austria"},
  {region:"æ¬§å·", flag:"ğŸ‡µğŸ‡±", jp:"ãƒãƒ¼ãƒ©ãƒ³ãƒ‰", en:"Poland"},
  {region:"æ¬§å·", flag:"ğŸ‡¨ğŸ‡¿", jp:"ãƒã‚§ã‚³", en:"Czech Republic"},
  {region:"æ¬§å·", flag:"ğŸ‡§ğŸ‡ª", jp:"ãƒ™ãƒ«ã‚®ãƒ¼", en:"Belgium"},
  // åŒ—ç±³
  {region:"åŒ—ç±³", flag:"ğŸ‡ºğŸ‡¸", jp:"ã‚¢ãƒ¡ãƒªã‚«", en:"United States"},
  {region:"åŒ—ç±³", flag:"ğŸ‡¨ğŸ‡¦", jp:"ã‚«ãƒŠãƒ€", en:"Canada"},
  // ä¸­å—ç±³
  {region:"ä¸­å—ç±³", flag:"ğŸ‡²ğŸ‡½", jp:"ãƒ¡ã‚­ã‚·ã‚³", en:"Mexico"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡§ğŸ‡·", jp:"ãƒ–ãƒ©ã‚¸ãƒ«", en:"Brazil"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡¦ğŸ‡·", jp:"ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³", en:"Argentina"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡¨ğŸ‡±", jp:"ãƒãƒª", en:"Chile"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡µğŸ‡ª", jp:"ãƒšãƒ«ãƒ¼", en:"Peru"},
  {region:"ä¸­å—ç±³", flag:"ğŸ‡¨ğŸ‡´", jp:"ã‚³ãƒ­ãƒ³ãƒ“ã‚¢", en:"Colombia"},
  // ã‚ªã‚»ã‚¢ãƒ‹ã‚¢
  {region:"ã‚ªã‚»ã‚¢ãƒ‹ã‚¢", flag:"ğŸ‡¦ğŸ‡º", jp:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢", en:"Australia"},
  {region:"ã‚ªã‚»ã‚¢ãƒ‹ã‚¢", flag:"ğŸ‡³ğŸ‡¿", jp:"ãƒ‹ãƒ¥ãƒ¼ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰", en:"New Zealand"},
  // ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¹ğŸ‡·", jp:"ãƒˆãƒ«ã‚³", en:"Turkey"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¸ğŸ‡¦", jp:"ã‚µã‚¦ã‚¸ã‚¢ãƒ©ãƒ“ã‚¢", en:"Saudi Arabia"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¦ğŸ‡ª", jp:"ã‚¢ãƒ©ãƒ–é¦–é•·å›½é€£é‚¦", en:"United Arab Emirates"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡¿ğŸ‡¦", jp:"å—ã‚¢ãƒ•ãƒªã‚«", en:"South Africa"},
  {region:"ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«", flag:"ğŸ‡ªğŸ‡¬", jp:"ã‚¨ã‚¸ãƒ—ãƒˆ", en:"Egypt"}
];

// åœ°åŸŸãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
const regionList = [...new Set(countryList.map(c => c.region))];
const regionSelect = document.getElementById('region-select');
regionList.forEach(region => {
  const opt = document.createElement('option');
  opt.value = region;
  opt.textContent = region;
  regionSelect.appendChild(opt);
});

// å›½ãƒªã‚¹ãƒˆã‚’åœ°åŸŸã§çµã‚Šè¾¼ã‚“ã§ç”Ÿæˆ
const countrySelect = document.getElementById('country-select');
function updateCountryOptions(selectedIdx) {
  const region = regionSelect.value;
  countrySelect.innerHTML = '';
  countryList.forEach((c, idx) => {
    if (c.region === region) {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = `${c.flag} ${c.jp} (${c.en})`;
      if (selectedIdx !== undefined && idx === selectedIdx) opt.selected = true;
      countrySelect.appendChild(opt);
    }
  });
}
regionSelect.onchange = () => updateCountryOptions();
updateCountryOptions();

document.getElementById('date-input').addEventListener('change', renderTable);

// æ—¥ä»˜è‡ªå‹•å…¥åŠ›ï¼ˆ22:00ï½ç¿Œ19:59ã¯å‰æ—¥ã‚’ã‚»ãƒƒãƒˆï¼‰
function getEigyoDate(dateObj = new Date()) {
  const hour = dateObj.getHours();
  if (hour >= 22 || hour < 19) {
    dateObj.setDate(dateObj.getDate() - 1);
  }
  const yyyy = dateObj.getFullYear();
  const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
  const dd = String(dateObj.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}
document.getElementById('date-input').value = getEigyoDate();

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
let countryData = [];
let editingIdx = null;

// Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
function loadCountryData() {
  db.ref('country').get().then(snapshot => {
    countryData = [];
    if (snapshot.exists()) {
      const obj = snapshot.val();
      Object.keys(obj).forEach(key => {
        countryData.push({ ...obj[key], key });
      });
    }
    renderTable();
  });
}

// æ™‚åˆ»ã‚’ã€Œhh:mmã€å½¢å¼ã§å–å¾—
function getNowTimeStr() {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2, '0');
  const mm = String(now.getMinutes()).padStart(2, '0');
  return `${hh}:${mm}`;
}

// ...existing code...

function renderTable() {
  const tbody = document.getElementById('country-table-body');
  tbody.innerHTML = '';
  // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  const selectedDate = document.getElementById('date-input').value;
  // countryDataã®é…åˆ—é †ï¼ˆæ–°ã—ã„å…¥åŠ›ãŒä¸Šï¼‰ã§ãƒ•ã‚£ãƒ«ã‚¿
  const filtered = countryData
    .map((row, idx) => ({ ...row, _originalIdx: idx })) // å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ
    .filter(row => row.date === selectedDate)
    .reverse(); // é…åˆ—ã®æœ«å°¾ãŒæ–°ã—ã„ã®ã§reverseã§æ–°ã—ã„é †ã«

  filtered.forEach((row) => {
    const c = countryList[row.countryIdx];
    // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.date}</td>
      <td>${row.time || ''}</td>
      <td>${c.region}</td>
      <td>${c.flag} ${c.jp} (${c.en})</td>
      <td>${row.count}</td>
      <td>
        <button onclick="deleteRow(${row._originalIdx})">å‰Šé™¤</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ...existing code...

function addCountryRow() {
  const date = document.getElementById('date-input').value;
  const countryIdx = Number(document.getElementById('country-select').value);
  const count = Number(document.getElementById('count-input').value);
  if (!date || isNaN(countryIdx) || !count || count < 1) {
    alert('æ—¥ä»˜ãƒ»åœ°åŸŸãƒ»å›½ãƒ»äººæ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  const time = getNowTimeStr();
  db.ref('country').push({ date, countryIdx, count, time }).then(() => {
    document.getElementById('count-input').value = '';
    loadCountryData();
  });
}

function startEdit(idx) {
  editingIdx = idx;
  renderTable();
}

function cancelEdit() {
  editingIdx = null;
  renderTable();
}

function saveEditRow(idx) {
  const row = countryData[idx];
  const date = document.getElementById(`edit-date-${idx}`).value;
  const region = document.getElementById(`edit-region-${idx}`).value;
  const countryIdx = Number(document.getElementById(`edit-country-${idx}`).value);
  const count = Number(document.getElementById(`edit-count-${idx}`).value);
  if (!date || isNaN(countryIdx) || !count || count < 1) {
    alert('æ—¥ä»˜ãƒ»åœ°åŸŸãƒ»å›½ãƒ»äººæ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
    renderTable();
    return;
  }
  db.ref('country/' + row.key).set({
    date, countryIdx, count, time: row.time
  }).then(() => {
    editingIdx = null;
    loadCountryData();
  });
}

function deleteRow(idx) {
  if (!confirm('ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const row = countryData[idx];
  db.ref('country/' + row.key).remove().then(() => {
    loadCountryData();
  });
}

function resetCountryData() {
  if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  db.ref('country').remove().then(() => {
    loadCountryData();
  });
}

// exportSummaryé–¢æ•°ï¼ˆcountryDataã‚’ä½¿ã†ï¼‰
function exportSummary() {
  const selectedDate = document.getElementById('date-input').value;
  if (!countryData.length || !selectedDate) {
    document.getElementById('export-text').value = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
    return;
  }
  const filtered = countryData.filter(row => row.date === selectedDate);
  if (!filtered.length) {
    document.getElementById('export-text').value = 'è©²å½“æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
    return;
  }
  // å›½ã”ã¨ã«é›†è¨ˆ
  const countryMap = {};
  filtered.forEach(row => {
    const c = countryList[row.countryIdx];
    const key = `${c.flag} ${c.jp} (${c.en})`;
    if (!countryMap[key]) countryMap[key] = 0;
    countryMap[key] += Number(row.count);
  });
  // å¤šã„é †ã«ä¸¦ã³æ›¿ãˆ
  const sorted = Object.entries(countryMap).sort((a, b) => b[1] - a[1]);
  const total = filtered.reduce((sum, row) => sum + Number(row.count), 0);
  let text = `æ—¥æ™‚ã€€èª¿æŸ»äººæ•°\n${selectedDate}ã€€${total}äºº\n\nå›½ã”ã¨ã®äººæ•°\n`;
  sorted.forEach(([name, count]) => {
    const percent = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
    text += `${name}ï¼š${count}äºº (${percent}%)\n`;
  });
  document.getElementById('export-text').value = text.trim();
}
// ...existing code...
function copyExportText() {
  const textarea = document.getElementById('export-text');
  textarea.select();
  document.execCommand('copy');
  alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}

// åˆæœŸè¡¨ç¤º
loadCountryData();
  </script>
</body>
</html>